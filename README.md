# [export-ADData](https://github.com/Tatsuya-Nonogaki/export-ADData)

## Overview

`export-ADData` is a PowerShell toolkit designed to export Active Directory (AD) Users and Groups to CSV files with flexible options.  
`import-ADData` is the flagship script for importing AD Users and Groups from CSV files, supporting a variety of migration and reorganization scenarios, including cross-domain moves, OU flattening, and detailed mapping.  
`compare-ADCSV` compares two AD export CSVs for verification.  
`check-ADUserPassword` is a utility for checking AD user password validity.

---

## Typical Workflow and Usage Scenarios

The intended usage is to export by specifying the domain basis, so that objects are output without losing their required attributes. If necessary, you are free to edit the exported CSV files, removing any unwanted entries, etc., before using it as input for the import. If you want to register password to any users, add a "Password" column to the User CSV (which is missing from the original), and put the password in plain text. Note that a password is required to restore the "Enabled" flag of the account.

When importing, four major strategies are expected:

1. **Export specifying "DC=domain,DC=local" and import to "DC=domain,DC=local"**  
   This is like backup and restore of AD users/groups. Note, however, that properties automatically generated by AD, such as GUID and SID, will have different values from the export source.

2. **Export specifying "DC=olddomain,DC=local" and import to "DC=newdomain,DC=local"**  
   Allocate the users/groups onto a new domain basis, translating the domain naming, respecting hierarchies.

3. **Export specifying "DC=domain,DC=local" and import to "OU=osaka,DC=domain,DC=local"**  
   Whole migration from the domain basis to a new specific OU, along with all intermediate OUs the users/groups depend on. In this case, users under CN=Users container are created just under OU=osaka because it is impossible to create "Users" container nor OU=Users under the OU. Specifying "newdomain" is also a viable choice, which is like a move to a different floor of a different building.

4. **Export specifying "OU=sales,DC=domain,DC=local" and import to "DC=domain,DC=local" with `-TrimOU OU=sales`**  
   Useful for flattening part of the OU hierarchy. By exporting from a specific OU and importing to the domain root with `-TrimOU`, you can migrate only the objects under that OU directly to the root (or another OU), effectively removing their original OU nesting.

---

## Scripts Included

### 1. export-ADData.ps1

#### Overview

Exports users and groups from Active Directory to CSV files using a specified domain or OU as the starting point.

#### Key Features

- Export AD Users and Groups to a pair of CSV files.
- Possible to exclude system objects from output.
- Supports specifying the export base via Distinguished Name (`-DNPath`) or dotted prefix (`-DNPrefix`).
- Flexible output path selection.

#### Parameters

| Parameter             | Alias     | Required | Description                                                                                           |
|-----------------------|-----------|----------|-------------------------------------------------------------------------------------------------------|
| `-DNPath`             | `-p`      | Yes\*    | Base of the Domain hierarchy from which you want to retrieve objects. DistinguishedName form.          |
| `-DNPrefix`           | `-d`      | Yes\*    | Alternative to `-DNPath`. Dotted format (e.g., `unit.domain.local`).                                  |
| `-DCDepth`            |           | No       | Depth of DC components in `-DNPrefix` (default: 2).                                                   |
| `-OutPath`            | `-o`      | No       | Folder path for output CSVs. Dialog prompts if omitted.                                               |
| `-ExcludeSystemObject`| `-nosys`  | No       | Exclude system users/groups from export.                                                              |

> \*Either `-DNPath` or `-DNPrefix` is required. They are mutually exclusive.

#### Usage Examples

```powershell
# Export AD Users and Groups from the Domain basis to CSV files in "C:\ADExport"
.\export-ADData.ps1 -DNPath "DC=mydomain,DC=local" -OutPath "C:\ADExport"

# Export AD Users and Groups using DNPrefix (not recommended for accuracy)
.\export-ADData.ps1 -DNPrefix "unit.mydomain.local" -OutPath "C:\ADExport"
```

---

### 2. import-ADData.ps1

#### Overview

Imports AD users and groups from CSV files, supporting domain migration, OU reorganization, and advanced mapping features. Automatically creates missing OUs and can handle a wide range of migration scenarios.

#### Key Features

- Import AD Users and Groups from CSV files.
- Optionally include system objects.
- Handle objects in `CN=Users` container specially and appropriately, redirecting them to a designated OU when needed.
- Create missing intermediate OUs during the import.
- Detailed logging of import operations.
- Option to disable "protect from accidental deletion" for newly created OUs, useful for pre-validation etc.
- Supports registering user passwords if provided in the CSV.
- Advanced features for OU trimming and control over Users container placement (`-TrimOU`, `-NoUsersContainer`).

#### Parameters

| Parameter             | Alias   | Required | Description                                                                                           |
|-----------------------|---------|----------|-------------------------------------------------------------------------------------------------------|
| `-DNPath`             | `-p`    | Yes\*    | Target base DN for import (e.g., `DC=newdomain,DC=local` or `OU=sales,DC=newdomain,DC=local`).        |
| `-DNPrefix`           | `-d`    | Yes\*    | Alternative to `-DNPath`. Dotted format (e.g., `unit.domain.local`).                                  |
| `-DCDepth`            |         | No       | Depth of DC components in `-DNPrefix` (default: 2).                                                   |
| `-User`               | `-u`    | No       | Import mode for users. Implied if `-UserFile` specified.                                              |
| `-UserFile`           | `-uf`   | No       | Path to user CSV file. Dialog prompts if omitted and `-User` is set.                                  |
| `-Group`              | `-g`    | No       | Import mode for groups. Implied if `-GroupFile` specified.                                            |
| `-GroupFile`          | `-gf`   | No       | Path to group CSV file. Dialog prompts if omitted and `-Group` is set.                                |
| `-IncludeSystemObject`|         | No       | Import critical system users/groups (normally dangerous).                                             |
| `-NewUPNSuffix`       |         | No       | New suffix for UserPrincipalName. Defaults to value derived from `-DNPath`.                           |
| `-NoProtectNewOU`     |         | No       | Newly created OUs will not be protected from accidental deletion.                                     |
| `-TrimOU`             |         | No       | Remove one or more leading OUs from source DNs before import.                                         |
| `-NoUsersContainer`   |         | No       | Place users/groups with no OU or in Users container directly under the domain root instead of `CN=Users,DC=...`.            |

> \*Either `-DNPath` or `-DNPrefix` is required. They are mutually exclusive.

---

#### Advanced Options

##### -TrimOU

Allows you to remove one or more leading OUs from the DistinguishedName of imported objects.  
- **Full DN format:** e.g., `OU=deeper,OU=sales`
- **Abbreviated format:** e.g., `deeper,sales` (converted internally)

The value must match the most descendant (left-most) OU sequence of the source DN, in order. Trimming only occurs if the source DN starts with the specified sequence.

**Examples:**

| Exported DN                             | -TrimOU Argument          | Resulting Path After Trim             | Explanation                                 |
|------------------------------------------|--------------------------|---------------------------------------|---------------------------------------------|
| OU=deeper,OU=sales,DC=domain,DC=local   | OU=sales                 | OU=deeper,OU=sales,DC=domain,DC=local | NO match (top OU is "deeper", not "sales")  |
| OU=deeper,OU=sales,DC=domain,DC=local   | OU=deeper,OU=sales       | DC=domain,DC=local                    | MATCH (exact sequence), both OUs trimmed    |
| OU=deeper,OU=sales,DC=domain,DC=local   | deeper                   | OU=sales,DC=domain,DC=local           | MATCH (top OU), "deeper" trimmed only       |
| OU=sales,DC=domain,DC=local             | OU=sales                 | DC=domain,DC=local                    | MATCH (top OU), "sales" trimmed             |

**Assumptions:**
- Trimming never removes DC components.
- Match is always from the start of the OU sequence.

**Precautions:**
- If, after trimming, no OU remains and the destination DNPath is the DC-root, see the behavior of `-NoUsersContainer` below.

---

##### -NoUsersContainer

By default, user or group objects imported directly under the domain root (with no OU) are placed in the domain's default container (`CN=Users,DC=...`).  
If you specify `-NoUsersContainer`, such objects are instead created directly under the domain root (`DC=...`).

**This applies in all situations:**  
- When importing objects originally with no OU (exported from domain root).
- When `-TrimOU` results in no OU remaining in the target DN.

**Precautions:**
- Source DNs in the `CN=Users` container (which only occurs directly above the DC-root) are treated the same way.
- Placing users or groups directly under the domain root is valid but not recommended for most environments.
- Some tools/scripts may not expect user/group objects directly under the DC-root.
- Use this option only if you are sure this is what you want.

---

#### Usage Examples

```powershell
# Import users, trimming two leading OUs, placing in Users container (default)
.\import-ADData.ps1 -DNPath "DC=newdomain,DC=local" -UserFile "Users.csv" -TrimOU "deeper,sales"

# Import users, trimming two leading OUs (full DN format), placing directly under domain root (not CN=Users)
.\import-ADData.ps1 -DNPath "DC=newdomain,DC=local" -UserFile "Users.csv" -TrimOU "OU=deeper,OU=sales" -NoUsersContainer

# Import users with no OUs, placing them directly under the domain root
.\import-ADData.ps1 -DNPath "DC=newdomain,DC=local" -UserFile "Users.csv" -NoUsersContainer
```

#### Best Practices and Safety Tips

- Always verify the target DNPath and run with test data before a production import.
- Use `-NoUsersContainer` with caution; direct-to-root objects can cause confusion in large AD environments.
- For bulk group/user imports, ensure all referenced groups will be created before member/user addition to avoid membership errors.

---

### 3. compare-ADCSV.ps1

#### Overview

Compares two CSV exports of AD users or groups, helping you verify changes, migrations, or synchronization.

#### Key Features

- Compare two CSV files of AD users or groups.
- Comparison is done with sAMAccountName as the key, without being affected by the order of records in the CSV file, unlike ordinary "diff" tools.
- Detects and outputs records where there is a difference in DistinguishedName, MemberOf, or when an entry is present only on one side.
- For user CSVs, differences in `Enabled` and `PasswordNeverExpires` are also checked and reported, but these fields are considered auxiliary and do not affect the main inclusion criteria.
- Optionally, you can include entries with no detected differences in the output (`-IncludeEqual` switch).
- Output is written to a CSV file or shown in the PowerShell console.

#### Parameters

| Parameter         | Alias | Required | Description                                      |
|-------------------|-------|----------|--------------------------------------------------|
| `-OldFile`        | `-o`  | Yes      | Old CSV file (source)                            |
| `-NewFile`        | `-n`  | Yes      | New CSV file (destination)                       |
| `-OutFile`        |       | No       | Output CSV file for results                      |
| `-IncludeEqual`   |       | No       | Include entries with no detected difference      |

#### Usage Examples

```powershell
# Compare two user CSVs and output differences to a file
.\compare-ADCSV.ps1 -OldFile "oldusers.csv" -NewFile "newusers.csv" -OutFile "diff.csv"

# Compare groups, show all entries (including identical)
.\compare-ADCSV.ps1 -OldFile "oldgroups.csv" -NewFile "newgroups.csv" -IncludeEqual
```

---

### 4. check-ADUserPassword.ps1

#### Overview

Checks whether a user's password is set as expected by querying AD.

#### Key Features

- Checks whether the user's password is set as expected by querying the AD.
- Domain can be preset in the script itself to save labor on frequent runs.

#### Parameters

| Parameter   | Alias | Required | Description                                                  |
|-------------|-------|----------|--------------------------------------------------------------|
| `-UserName` | `-u`  | Yes      | Username to validate                                         |
| `-Password` | `-p`  | Yes      | Password in plain text (prompted if omitted)                 |
| `-Domain`   | `-d`  | No       | AD Domain to query (dot or DN format; uses preset if omitted)|

#### Usage Example

```powershell
# Check if the user's password is correct
.\check-ADUserPassword.ps1 -UserName "jdoe" -Password "password123"
```

---

## Logging

`import-ADData.ps1` maintains a detailed log of all operations and errors. The log file is saved as `import-ADData.log` in the script directory.

---

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

---

## Author

Tatsuya Nonogaki
